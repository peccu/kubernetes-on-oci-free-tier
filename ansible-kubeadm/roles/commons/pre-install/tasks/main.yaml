---

- name: Install curl
  ansible.builtin.dnf:
    pkg:
      - curl

- name: disable SELinux
  command: setenforce 0

- name: Ensure SELinux is set to enforcing mode
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: SELINUX=permissive

- name: "Create kubernetes.repo"
  copy:
    src: "kubernetes.repo"
    dest: "/etc/yum.repos.d/kubernetes.repo"
    mode: 0644

- name: Install kubeadm, kubelet, kubectl
  ansible.builtin.dnf:
    disable_excludes: kubernetes
    pkg:
      - kubeadm
      - kubelet
      - kubectl

# https://www.reddit.com/r/linuxadmin/comments/flzx5r/comment/fl1uaoz/
- name: Disable swap for current session
  command: swapoff -a
  become: true

- name: Disable swap permanently, persist reboots
  replace:
    path: /etc/fstab
    regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
    replace: '#\1\2\3swap\4'
    backup: yes

- name: modprobe br_netfilter
  command: modprobe br_netfilter

- name: modprobe overlay
  command: modprobe overlay

- name: Disable swappiness and pass bridged IPv4 traffic to iptable's chains
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  with_items:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }

- name: Reload kubelet daemon
  systemd:
    name: kubelet
    daemon_reload: yes
    enabled: yes
